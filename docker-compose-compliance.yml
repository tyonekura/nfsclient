services:
  nfsd:
    build:
      context: ../project
    command:
      - bash
      - -c
      - |
        set -e
        mkdir -p /export
        rpcbind
        sleep 1
        exec /app/build/nfsd --export /export --port 2049
    networks:
      - nfs-compliance

  compliance:
    build:
      context: .
    volumes:
      - .:/src
    depends_on:
      - nfsd
    environment:
      NFS_SERVER: nfsd
    command:
      - bash
      - -c
      - |
        set -e
        cmake -B build -DCMAKE_BUILD_TYPE=Debug
        cmake --build build -j$(nproc)
        echo 'Waiting for nfsd to be ready...'
        until bash -c 'echo > /dev/tcp/nfsd/2049' 2>/dev/null; do sleep 1; done
        echo 'nfsd is up, running compliance tests...'
        exec ./build/tools/compliance/nfsclient_compliance \
          --server nfsd --export /
    networks:
      - nfs-compliance

networks:
  nfs-compliance:
    driver: bridge
